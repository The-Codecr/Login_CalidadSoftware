---
import ResetPasswordLayout from "@layouts/resetPassword.astro";

const email = Astro.url.searchParams.get("email") ?? "";
const token = Astro.url.searchParams.get("token") ?? "";
---

<ResetPasswordLayout>
  <div class="w-full max-w-md mx-auto mt-20 bg-white/60 backdrop-blur-lg p-8 rounded-2xl shadow-xl">
    <h1 class="text-2xl font-semibold text-center mb-6 text-gray-700">
      Restablecer contraseña a {email}
    </h1>

    {(!email || !token) && (
      <p class="text-red-600 text-center font-semibold">
        Enlace inválido o incompleto.
      </p>
    )}

    {(email && token) && (
      <div>
        <!-- Requisitos de contraseña -->
        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <p class="text-sm text-blue-800 font-medium mb-1">Requisitos de contraseña:</p>
          <ul class="text-xs text-blue-700 space-y-1">
            <li>• Entre 5 y 10 caracteres</li>
            <li>• Al menos una mayúscula (A-Z)</li>
            <li>• Al menos un carácter especial (!@#$%^&*...)</li>
          </ul>
        </div>

        <form id="newPasswordForm" class="space-y-4">
          <input type="hidden" id="email" value={email} />
          <input type="hidden" id="token" value={token} />

          <div>
            <label class="block text-gray-600 mb-1">Nueva Contraseña</label>
            <div class="relative">
              <input 
                id="password"
                type="password"
                required
                maxlength="10"
                class="w-full px-3 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Ingrese contraseña"
              />

              <button
                type="button"
                id="togglePassword"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 hover:text-gray-800"
              >
                <svg id="eyeOpen1" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" 
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7
                    -1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>

                <svg id="eyeClosed1" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" 
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7
                    a10.05 10.05 0 012.007-3.592M6.18 6.18A9.96 9.96 0 0112 5c4.478 0 
                    8.268 2.943 9.542 7a9.96 9.96 0 01-4.46 5.568M15 12a3 3 0 00-3-3
                    m3 3a3 3 0 01-3 3m0-3a3 3 0 00-3-3m3 3a3 3 0 01-3 3M3 3l18 18"/>
                </svg>
              </button>
            </div>
            <!-- Indicador de fuerza de contraseña -->
            <div id="passwordStrength" class="mt-2 hidden">
              <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="strengthBar" class="h-full transition-all duration-300"></div>
              </div>
              <p id="strengthText" class="text-xs mt-1"></p>
            </div>
          </div>

          <div>
            <label class="block text-gray-600 mb-1">Confirmar Contraseña</label>
            <div class="relative">
              <input 
                id="password2"
                type="password"
                required
                maxlength="10"
                class="w-full px-3 py-2 pr-10 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Confirme contraseña"
              />

              <button
                type="button"
                id="togglePassword2"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 hover:text-gray-800"
              >
                <svg id="eyeOpen2" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" 
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7
                    -1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>

                <svg id="eyeClosed2" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" 
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7
                    a10.05 10.05 0 012.007-3.592M6.18 6.18A9.96 9.96 0 0112 5c4.478 0 
                    8.268 2.943 9.542 7a9.96 9.96 0 01-4.46 5.568M15 12a3 3 0 00-3-3
                    m3 3a3 3 0 01-3 3m0-3a3 3 0 00-3-3m3 3a3 3 0 01-3 3M3 3l18 18"/>
                </svg>
              </button>
            </div>
          </div>

          <button type="submit" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
            Guardar Nueva Contraseña
          </button>
        </form>
      </div>
    )}
  </div>

  <script type="module">
    import { setupResetPasswordForm } from "/src/scripts/resetPassword";
    import { validatePassword } from "/src/utils/passwordValidator";

    // Toggle para mostrar/ocultar contraseñas
    const toggle = (btnId, inputId, openId, closeId) => {
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);
      const eye = document.getElementById(openId);
      const eye2 = document.getElementById(closeId);

      btn?.addEventListener("click", () => {
        const isText = input.type === "text";
        input.type = isText ? "password" : "text";
        eye.classList.toggle("hidden", !isText);
        eye2.classList.toggle("hidden", isText);
      });
    };

    toggle("togglePassword", "password", "eyeOpen1", "eyeClosed1");
    toggle("togglePassword2", "password2", "eyeOpen2", "eyeClosed2");

    // Validación en tiempo real de la contraseña
    const passwordInput = document.getElementById("password");
    const strengthDiv = document.getElementById("passwordStrength");
    const strengthBar = document.getElementById("strengthBar");
    const strengthText = document.getElementById("strengthText");

    passwordInput?.addEventListener("input", (e) => {
      const password = e.target.value;
      
      if (password.length === 0) {
        strengthDiv.classList.add("hidden");
        return;
      }

      strengthDiv.classList.remove("hidden");
      const validation = validatePassword(password);

      if (validation.isValid) {
        strengthBar.style.width = "100%";
        strengthBar.className = "h-full transition-all duration-300 bg-green-500";
        strengthText.textContent = "✓ Contraseña válida";
        strengthText.className = "text-xs mt-1 text-green-600";
      } else {
        const percentage = ((4 - validation.errors.length) / 4) * 100;
        strengthBar.style.width = `${percentage}%`;
        
        if (percentage < 50) {
          strengthBar.className = "h-full transition-all duration-300 bg-red-500";
          strengthText.className = "text-xs mt-1 text-red-600";
        } else {
          strengthBar.className = "h-full transition-all duration-300 bg-yellow-500";
          strengthText.className = "text-xs mt-1 text-yellow-600";
        }
        
        strengthText.textContent = validation.errors[0];
      }
    });

    setupResetPasswordForm();
  </script>
</ResetPasswordLayout>